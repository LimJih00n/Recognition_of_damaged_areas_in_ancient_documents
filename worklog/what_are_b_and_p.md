# b와 p의 의미

**작성일**: 2025-10-29

---

## b = LAB 색공간의 b-channel

### LAB 색공간이란?
```
L: Lightness (명도) - 0(검정)~100(흰색)
a: Green(-) ↔ Red(+) 축
b: Blue(-) ↔ Yellow(+) 축
```

### b-channel의 의미
```
b < 128: 파란색 계열
b = 128: 중립 (회색, 무채색)
b > 128: 노란색 계열
```

### 문서에서 b값의 의미

**구멍 (손상 부위)**:
- b값이 낮음 (b < 140)
- 거의 흰색 또는 약간 파란 톤
- 베이지/노란색이 **아님**

**종이 (정상 부위)**:
- b값이 높음 (b ≥ 140)
- 베이지색, 노란색으로 변색됨
- 세월이 지나 산화됨

### 예시
```
b=130: 거의 순백색 구멍
b=135: 흰색~약간 크림색 구멍
b=138: 흰색~약간 노란 구멍 ⭐ (권장)
b=140: 노란색까지 포함
b=144: 베이지색도 포함
```

---

## p = Percentile (백분위수)

### Percentile이란?
데이터를 작은 값부터 큰 값 순으로 정렬했을 때, 특정 위치의 값

### 예시
```
데이터: [100, 120, 130, 140, 150, 160, 170, 180, 190, 200]

p=10 (10%): 120 (아래에서 10% 지점)
p=25 (25%): 135 (아래에서 25% 지점)
p=33 (33%): 140 (아래에서 33% 지점)
p=50 (50%): 155 (중간값, median)
```

### 이미지에서 p의 의미

**전체 픽셀의 b값을 정렬한 후, p% 지점의 값을 threshold로 사용**

```
p=25: 가장 흰색인 25% 픽셀까지
p=30: 가장 흰색인 30% 픽셀까지
p=33: 가장 흰색인 33% 픽셀까지
p=50: 중간 정도까지 (전체의 50%)
```

---

## b (고정) vs p (자동)의 차이

### 고정 b값 (--s-threshold)
```bash
--s-threshold 138
```

**의미**:
- **모든 이미지에서 b<138인 픽셀을 구멍으로 판단**
- 이미지와 무관하게 항상 138 사용

**장점**:
- 일관성: 모든 이미지에 동일한 기준
- 재현성: 항상 같은 결과
- 명확성: "b<138=구멍"이라는 명확한 정의

**예시**:
```
test_small (평균 b=141.7)
→ b<138인 픽셀 찾기 → 254개 구멍

w_0005 (평균 b=144.1)
→ b<138인 픽셀 찾기 → 239개 구멍
```

---

### 자동 p값 (--s-percentile)
```bash
--s-percentile 33
```

**의미**:
- **각 이미지마다 p33 지점의 b값을 계산해서 threshold로 사용**
- 이미지마다 다른 threshold 사용

**장점**:
- 적응성: 이미지 색상 분포에 자동 적응

**단점**:
- 일관성 부족: 이미지마다 다른 threshold
- 예측 불가: 어떤 threshold가 나올지 모름

**예시**:
```
test_small (평균 b=141.7)
→ p33 계산 → b<140 사용 → 258개 구멍

w_0005 (평균 b=144.1)
→ p33 계산 → b<144 사용 → 18,920개 구멍 (너무 많음!)
```

---

## 실제 비교

### test_small.jpg (평균 b=141.7)

**고정 b=138**:
```
모든 픽셀의 b값을 확인
→ b<138인 픽셀을 구멍으로 판단
→ 254개 구멍
```

**자동 p=33**:
```
전체 픽셀의 b값을 작은 순서로 정렬
→ 33% 지점의 값 = 140
→ b<140인 픽셀을 구멍으로 판단
→ 258개 구멍
```

차이: 4개 (거의 비슷)

---

### w_0005.tif (평균 b=144.1)

**고정 b=138**:
```
모든 픽셀의 b값을 확인
→ b<138인 픽셀을 구멍으로 판단
→ 239개 구멍
```

**자동 p=33**:
```
전체 픽셀의 b값을 작은 순서로 정렬
→ 33% 지점의 값 = 144
→ b<144인 픽셀을 구멍으로 판단
→ 18,920개 구멍 (너무 많음!)
```

차이: 79배! (엄청난 차이)

---

## 왜 w_0005에서 p가 실패했는가?

### 문제: w_0005의 b값 분포

```
w_0005는 전체적으로 베이지/노란색으로 변색된 문서

대부분 픽셀의 b값이 140~150 사이에 몰려있음

p=33 (33% 지점) = 144
→ 전체 픽셀의 33%가 144 미만
→ 33%는 매우 넓은 영역!
→ 18,920개 검출
```

### test_small은 왜 괜찮았는가?

```
test_small은 배경이 비교적 깨끗

b값 분포가 더 넓게 퍼져있음

p=33 (33% 지점) = 140
→ 진짜 구멍 영역만 140 미만
→ 258개 검출 (적당)
```

---

## 결론

### b (고정 threshold)
```
--s-threshold 138

의미: b<138인 픽셀 = 구멍
물리적 의미: 흰색~약간 노란색
모든 이미지에 동일한 기준
```

### p (percentile 자동)
```
--s-percentile 33

의미: 가장 흰색인 33% 픽셀 = 구멍
이미지마다 다른 threshold 계산
배경이 깨끗한 이미지에 적합
```

---

## 시각적 설명

### LAB 색공간의 b축
```
     Blue                  Yellow
      ←─────────|─────────→

      100      128      150      200
       |        |         |        |
    순백색   중립(회색)  약간노란  노란색

                b=138 ⭐
                 ↑
            우리가 사용하는
            threshold 위치
```

### Percentile 개념
```
전체 픽셀의 b값을 정렬:

[120, 125, 130, 135, 138, 140, 142, 144, 146, 148, ...]
                    ↑
                  p=33
              (아래 33% 지점)
```

---

## 최종 권장

**고정 b=138 사용 ⭐**

```bash
python extract_whiteness_based.py \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10
```

**이유**:
- 명확한 물리적 의미
- 모든 이미지에 일관된 기준
- test_small과 w_0005 모두 적절한 결과
