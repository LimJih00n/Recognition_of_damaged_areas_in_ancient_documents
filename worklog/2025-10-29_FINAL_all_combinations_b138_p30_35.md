# 최종 전체 조합 비교: b=138 + p=30~35

**작성일**: 2025-10-29
**테스트**: 고정 b=138 + percentile p=30~35 모든 조합

---

## 전체 비교표

### test_small.jpg (1443 x 1082, 평균 b=141.7)

| 파라미터 | 실제 threshold | Coverage | 구멍 개수 | 비고 |
|----------|---------------|----------|----------|------|
| **고정 b=135** | b < 135 | 31.43% | 241개 | - |
| **고정 b=138** | b < 138 | 32.40% | **254개** | ⭐ |
| **고정 b=140** | b < 140 | 32.91% | 258개 | - |
| **p=30** | b < 134 | 29.84% | 233개 | - |
| **p=31** | b < 134 | 29.84% | 233개 | (p30과 동일) |
| **p=32** | b < 136 | 31.82% | 245개 | - |
| **p=33** | b < 140 | 32.91% | 258개 | - |
| **p=34** | b < 143 | 33.83% | 296개 | - |
| **p=35** | b < 143 | 33.83% | 296개 | (p34와 동일) |

### w_0005.tif (7216 x 5412, 평균 b=144.1)

| 파라미터 | 실제 threshold | Coverage | 구멍 개수 | 비고 |
|----------|---------------|----------|----------|------|
| **고정 b=135** | b < 135 | 15.38% | 249개 | ⭐ |
| **고정 b=138** | b < 138 | 15.89% | **239개** | ⭐⭐ |
| **고정 b=140** | b < 140 | 16.20% | 877개 | - |
| **p=30** | b < 144 | 26.64% | 18,920개 | 너무 많음 |
| **p=31** | b < 144 | 26.64% | 18,920개 | 너무 많음 |
| **p=32** | b < 144 | 26.64% | 18,920개 | 너무 많음 |
| **p=33** | b < 144 | 26.64% | 18,920개 | 너무 많음 |
| **p=34** | b < 144 | 26.64% | 18,920개 | 너무 많음 |
| **p=35** | b < 144 | 26.64% | 18,920개 | 너무 많음 |

---

## 핵심 발견

### 1. w_0005에서 percentile 방식의 문제점

**놀라운 발견**: p=30~35가 **모두 b=144로 동일!**

**원인**:
- w_0005의 b값 분포가 매우 좁음 (평균 144.1 ± 6.7)
- p30~p35가 모두 **144 근처에 몰려있음**
- 결과: 모든 percentile이 18,920개 검출 (너무 많음)

**결론**: **w_0005에는 percentile 방식이 부적합!**

---

### 2. 고정 threshold의 우수성

**test_small에서**:
- b=138: 254개
- p=33: 258개 (b=140 자동 계산)
- 차이: 4개 (거의 동일)

**w_0005에서**:
- b=138: **239개** ⭐⭐
- p=30~35: **18,920개** (79배 많음!)
- 차이: 엄청남!

**결론**: **고정 threshold가 훨씬 안정적!**

---

## 최종 최적 파라미터: b=138 ⭐⭐

### 비교 (고정값들)

| Threshold | test_small | w_0005 | 평가 |
|-----------|-----------|--------|------|
| **b=135** | 241개 | 249개 | ✅ 비슷함 |
| **b=138** | **254개** | **239개** | ✅✅ **거의 동일!** |
| **b=140** | 258개 | 877개 | ⚠️ w_0005 많음 |

### b=138의 장점

1. **일관성**: test_small 254개 ≈ w_0005 239개 (거의 동일!)
2. **균형**: 두 이미지 모두 적당한 개수
3. **안정성**: percentile의 18,920개 대비 엄청난 개선
4. **재현성**: 항상 같은 기준

---

## 최종 권장 명령어

```bash
python extract_whiteness_based.py \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10
```

### 적용 예시

**test_small.jpg**:
```bash
python extract_whiteness_based.py \
  --input "datasets/test_small.jpg" \
  --output-dir results/test_small_b138 \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10
```
→ **결과**: 254개 구멍

**w_0005.tif**:
```bash
python extract_whiteness_based.py \
  --input "datasets/1첩/w_0005.tif" \
  --output-dir results/w_0005_b138 \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10
```
→ **결과**: 239개 구멍

---

## 출력 디렉토리 목록

### 고정 threshold 결과
- `results/test_small_b135/` - 241개
- `results/test_small_b138/` - 254개 ⭐
- `results/test_small_b140/` - 258개
- `results/w_0005_b135/` - 249개
- `results/w_0005_b138/` - 239개 ⭐
- `results/w_0005_b140/` - 877개

### Percentile 결과
- `results/test_small_p30/` - 233개 (b=134)
- `results/test_small_p31/` - 233개 (b=134)
- `results/test_small_p32/` - 245개 (b=136)
- `results/test_small_p33/` - 258개 (b=140)
- `results/test_small_p34/` - 296개 (b=143)
- `results/test_small_p35/` - 296개 (b=143)
- `results/w_0005_p30/` - 18,920개 (b=144) ⚠️
- `results/w_0005_p31/` - 18,920개 (b=144) ⚠️
- `results/w_0005_p32/` - 18,920개 (b=144) ⚠️
- `results/w_0005_p33/` - 18,920개 (b=144) ⚠️
- `results/w_0005_p34/` - 18,920개 (b=144) ⚠️
- `results/w_0005_p35/` - 18,920개 (b=144) ⚠️

---

## 시각적 비교

### 구멍 개수 (test_small)
```
200     250     300
|-------+-------|
        ↓ b=138 (254)
233 ------------------- 296
p30                   p35
```

### 구멍 개수 (w_0005)
```
0       500     10000   20000
|-------+-------|-------|
  ↓ b=138 (239)
249 -------------------------------------------- 18920
b=135                                          p30~35
```

**결론**: w_0005에서 고정값(239개)과 percentile(18,920개)의 차이가 극명!

---

## 왜 percentile이 w_0005에서 실패했는가?

### w_0005의 b값 분포
```
평균: 144.1 ± 6.7

분포가 매우 좁음:
  p30 = 144
  p31 = 144
  p32 = 144
  p33 = 144
  p34 = 144
  p35 = 144

모두 144에 몰려있음!
```

### test_small의 b값 분포
```
평균: 141.7 ± 7.6

분포가 더 넓음:
  p30 = 134
  p31 = 134
  p32 = 136
  p33 = 140
  p34 = 143
  p35 = 143

더 다양한 값
```

**결론**: w_0005는 이미 얼룩지고 변색된 문서라서, b값이 대부분 144 근처에 몰려있음. Percentile 방식은 이런 경우에 부적합!

---

## 최종 결론

### 🏆 최종 승자: **고정 b=138** 🏆

**이유**:
1. ✅ test_small과 w_0005에서 **거의 동일한 개수** (254 vs 239)
2. ✅ percentile의 과검출 문제 해결 (18,920 → 239)
3. ✅ 모든 이미지에 **일관된 기준** 적용
4. ✅ 재현성 완벽
5. ✅ 물리적 의미 명확 (b<138 = 흰색~약간 노란색)

### 📝 사용법

```bash
# 단일 이미지
python extract_whiteness_based.py \
  --input "your_image.jpg" \
  --output-dir results/output \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10

# 배치 처리
for img in datasets/1첩/*.tif; do
    name=$(basename "$img" .tif)
    python extract_whiteness_based.py \
      --input "$img" \
      --output-dir "results/${name}_b138" \
      --method lab_b \
      --s-threshold 138 \
      --min-area 10
done
```

---

## 비교 요약표 (눈으로 확인용)

### test_small.jpg
| 방법 | 개수 | threshold |
|------|------|-----------|
| p=30 | 233 | b<134 |
| p=31 | 233 | b<134 |
| p=32 | 245 | b<136 |
| p=33 | 258 | b<140 |
| p=34 | 296 | b<143 |
| p=35 | 296 | b<143 |
| **b=135** | **241** | **b<135** |
| **b=138** | **254** ⭐ | **b<138** |
| **b=140** | **258** | **b<140** |

### w_0005.tif
| 방법 | 개수 | threshold |
|------|------|-----------|
| p=30 | 18920 | b<144 |
| p=31 | 18920 | b<144 |
| p=32 | 18920 | b<144 |
| p=33 | 18920 | b<144 |
| p=34 | 18920 | b<144 |
| p=35 | 18920 | b<144 |
| **b=135** | **249** | **b<135** |
| **b=138** | **239** ⭐⭐ | **b<138** |
| **b=140** | **877** | **b<140** |

**각 결과의 comparison.png를 확인하세요!**
