# 다중 이미지 테스트: b=138

**작성일**: 2025-10-29
**파라미터**: `--method lab_b --s-threshold 138 --min-area 10`

---

## 전체 결과 비교표

| 이미지 | 크기 | 평균 b값 | Coverage | 구멍 개수 | 최대 구멍 | 총 손상 면적 | 평가 |
|--------|------|---------|----------|----------|----------|-------------|------|
| **test_small.jpg** | 1443x1082 | 141.7±7.6 | 32.40% | 254 | 2,477 px | 23,764 px (1.52%) | ✅ 적당 |
| **w_0001.tif** | 7216x5412 | 141.6±7.9 | 32.70% | 335 | **71,158 px** | 753,494 px (1.93%) | ✅ 적당 |
| **w_0003.tif** | 7216x5412 | 143.8±6.6 | 15.56% | 267 | 49,840 px | 411,886 px (1.05%) | ✅ 적당 |
| **w_0005.tif** | 7216x5412 | 144.1±6.7 | 15.89% | 239 | 17,676 px | 252,193 px (0.65%) | ✅ 적당 |
| **w_0007.tif** | 7216x5412 | 143.5±6.0 | 14.28% | 367 | 61,350 px | 429,198 px (1.10%) | ✅ 적당 |
| **w_0010.tif** | 7216x5412 | 138.2±8.0 | 52.91% | 348 | **73,984 px** | 431,252 px (1.10%) | ⚠️ 많음 |
| **w_0015.tif** | 7216x5412 | 144.9±5.7 | 11.36% | 163 | 49,955 px | 211,946 px (0.54%) | ✅ 적당 |
| **w_0018.tif** | 5412x7216 | 137.8±8.5 | 51.93% | **2,626** | 4,872 px | 140,263 px (0.36%) | ⚠️ 매우 많음 |

---

## 핵심 발견

### 1. max-area 증가 필요성 확인

**문제**: 기본 max-area=100,000 pixels로는 큰 구멍을 놓칠 수 있음

**증거**:
- w_0001: 최대 구멍 **71,158 px**
- w_0010: 최대 구멍 **73,984 px**

**해결**: max-area를 **200,000** 이상으로 설정 권장

```bash
--max-area 200000
```

---

### 2. 이미지별 특성 분류

#### 그룹 A: 깨끗한 배경 (b평균 ≈ 141-142)
- **test_small.jpg**: b=141.7, Coverage 32.40%
- **w_0001.tif**: b=141.6, Coverage 32.70%

**특징**:
- Coverage 높음 (32%대)
- 구멍 개수 적당 (254-335개)
- 큰 구멍 존재 (w_0001: 71k pixels)

---

#### 그룹 B: 약간 변색된 배경 (b평균 ≈ 143-145)
- **w_0003.tif**: b=143.8, Coverage 15.56%
- **w_0005.tif**: b=144.1, Coverage 15.89%
- **w_0007.tif**: b=143.5, Coverage 14.28%
- **w_0015.tif**: b=144.9, Coverage 11.36%

**특징**:
- Coverage 낮음 (11-16%)
- 구멍 개수 적당 (163-367개)
- 배경이 노란색으로 변색됨

---

#### 그룹 C: 심각한 손상 (b평균 ≈ 137-138, threshold에 근접)
- **w_0010.tif**: b=138.2, Coverage 52.91%
- **w_0018.tif**: b=137.8, Coverage 51.93%

**특징**:
- Coverage 매우 높음 (50%대!)
- w_0010: 큰 구멍들 (평균 1,239 px)
- w_0018: 작지만 매우 많은 구멍들 (2,626개!)

**주의**:
- 평균 b값이 threshold(138)에 매우 근접
- 전체 이미지의 절반 이상이 손상
- b=138로는 과검출 가능성

---

## 상세 분석

### test_small.jpg (기준 이미지)
```
크기: 1443 x 1082 (1.56 MP)
평균 b: 141.7 ± 7.6
Coverage: 32.40%
구멍: 254개
면적 범위: 10 - 2,477 px
평균 면적: 93.6 px
중간값 면적: 50.2 px
총 손상: 23,764 px (1.52%)
```

**평가**:
- ✅ 깨끗한 배경
- ✅ 적당한 구멍 개수
- ✅ b=138 최적

---

### w_0001.tif (큰 구멍)
```
크기: 7216 x 5412 (39.06 MP)
평균 b: 141.6 ± 7.9
Coverage: 32.70%
구멍: 335개
면적 범위: 10 - 71,158 px ⚠️
평균 면적: 2,249.2 px
중간값 면적: 1,395.5 px
총 손상: 753,494 px (1.93%)
```

**평가**:
- ✅ test_small과 비슷한 b값 분포
- ⚠️ **매우 큰 구멍 존재** (71k pixels)
- 💡 max-area=200k 필요

---

### w_0003.tif (변색)
```
크기: 7216 x 5412 (39.06 MP)
평균 b: 143.8 ± 6.6
Coverage: 15.56%
구멍: 267개
면적 범위: 10 - 49,840 px
평균 면적: 1,542.6 px
중간값 면적: 776.5 px
총 손상: 411,886 px (1.05%)
```

**평가**:
- ✅ 배경이 노란색으로 변색
- ✅ b=138로 정확히 구분 가능
- ✅ Coverage 낮음 (진짜 구멍만)

---

### w_0005.tif (변색, 기준 비교용)
```
크기: 7216 x 5412 (39.06 MP)
평균 b: 144.1 ± 6.7
Coverage: 15.89%
구멍: 239개
면적 범위: 10 - 17,676 px
평균 면적: 1,055.2 px
중간값 면적: 227.5 px
총 손상: 252,193 px (0.65%)
```

**평가**:
- ✅ 가장 변색된 문서 중 하나
- ✅ b=138로 안정적 검출
- ✅ 적당한 구멍 개수

---

### w_0007.tif (많은 윤곽선)
```
크기: 7216 x 5412 (39.06 MP)
평균 b: 143.5 ± 6.0
Coverage: 14.28%
구멍: 367개
면적 범위: 10 - 61,350 px
평균 면적: 1,169.5 px
중간값 면적: 58.0 px
총 손상: 429,198 px (1.10%)

총 윤곽선: 853개
제외됨: 486개
```

**평가**:
- ✅ 많은 작은 노이즈 (486개 제외됨)
- ✅ min-area=10으로 필터링 효과적
- ⚠️ 큰 구멍 존재 (61k pixels)

---

### w_0010.tif (심각한 손상)
```
크기: 7216 x 5412 (39.06 MP)
평균 b: 138.2 ± 8.0 ⚠️
Coverage: 52.91% ⚠️
구멍: 348개
면적 범위: 10 - 73,984 px ⚠️
평균 면적: 1,239.2 px
중간값 면적: 57.8 px
총 손상: 431,252 px (1.10%)
```

**평가**:
- ⚠️ 평균 b=138.2 (threshold에 매우 근접!)
- ⚠️ Coverage 52.91% (절반 이상 손상)
- ⚠️ 매우 큰 구멍 (73k pixels)
- 💡 이 문서는 b=138로 과검출 가능

**제안**: w_0010은 threshold를 낮춰볼 필요 (b=135 등)

---

### w_0015.tif (가장 변색)
```
크기: 7216 x 5412 (39.06 MP)
평균 b: 144.9 ± 5.7 (가장 높음)
Coverage: 11.36% (가장 낮음)
구멍: 163개 (가장 적음)
면적 범위: 10 - 49,955 px
평균 면적: 1,300.3 px
중간값 면적: 766.0 px
총 손상: 211,946 px (0.54%)
```

**평가**:
- ✅ 가장 노란색으로 변색된 문서
- ✅ b=138로 정확히 구멍만 검출
- ✅ 과검출 없음

---

### w_0018.tif (매우 심각한 손상)
```
크기: 5412 x 7216 (39.06 MP, 회전됨)
평균 b: 137.8 ± 8.5 ⚠️
Coverage: 51.93% ⚠️
구멍: 2,626개 ⚠️⚠️⚠️
면적 범위: 10 - 4,872 px
평균 면적: 53.4 px (작음)
중간값 면적: 23.5 px (매우 작음)
총 손상: 140,263 px (0.36%)

총 윤곽선: 5,950개
제외됨: 3,324개
```

**평가**:
- ❌ 평균 b=137.8 (threshold보다 낮음!)
- ❌ Coverage 51.93% (절반 이상)
- ❌ 2,626개 구멍 (너무 많음)
- ❌ 작은 구멍들이 매우 많음

**문제**:
- 전체 이미지가 심각하게 손상됨
- 평균 b값이 threshold보다 낮음
- b=138로는 부적합

**제안**: w_0018은 다른 방법 필요 (edge detection 등)

---

## b값과 Coverage의 관계

```
평균 b값    Coverage    평가
─────────────────────────────────────
137.8 (w_0018)  51.93%   ⚠️ threshold보다 낮음
138.2 (w_0010)  52.91%   ⚠️ threshold에 매우 근접
141.6 (w_0001)  32.70%   ✅ 적당
141.7 (test)    32.40%   ✅ 적당
143.5 (w_0007)  14.28%   ✅ 적당
143.8 (w_0003)  15.56%   ✅ 적당
144.1 (w_0005)  15.89%   ✅ 적당
144.9 (w_0015)  11.36%   ✅ 적당
```

**패턴**:
- b평균 < 138: 과검출 (전체가 손상된 문서)
- b평균 ≈ 138-142: Coverage 높음 (32%대)
- b평균 ≈ 143-145: Coverage 낮음 (11-16%)

**결론**: b=138은 b평균이 **140 이상**인 문서에 최적

---

## 최대 구멍 크기 분포

| 이미지 | 최대 구멍 | 판정 |
|--------|----------|------|
| test_small | 2,477 px | ✅ |
| w_0005 | 17,676 px | ✅ |
| w_0018 | 4,872 px | ✅ |
| w_0003 | 49,840 px | ✅ |
| w_0015 | 49,955 px | ✅ |
| w_0007 | 61,350 px | ✅ |
| **w_0001** | **71,158 px** | ⚠️ max-area=100k 초과 |
| **w_0010** | **73,984 px** | ⚠️ max-area=100k 초과 |

**결론**: **max-area=200000** 필요!

---

## 권장 설정

### 일반 문서 (b평균 > 140)
```bash
python extract_whiteness_based.py \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10 \
  --max-area 200000
```

**적용 대상**:
- test_small.jpg (b=141.7) ✅
- w_0001.tif (b=141.6) ✅
- w_0003.tif (b=143.8) ✅
- w_0005.tif (b=144.1) ✅
- w_0007.tif (b=143.5) ✅
- w_0015.tif (b=144.9) ✅

---

### 심각한 손상 문서 (b평균 ≈ 138)
```bash
python extract_whiteness_based.py \
  --method lab_b \
  --s-threshold 135 \  # 더 낮춤
  --min-area 10 \
  --max-area 200000
```

**적용 대상**:
- w_0010.tif (b=138.2) ⚠️
- w_0018.tif (b=137.8) ⚠️

---

## 배치 처리 스크립트

### 모든 이미지 일괄 처리
```bash
# 1첩 전체 처리 (b=138)
for img in datasets/1첩/*.tif; do
    name=$(basename "$img" .tif)
    python extract_whiteness_based.py \
      --input "$img" \
      --output-dir "results/${name}_b138" \
      --method lab_b \
      --s-threshold 138 \
      --min-area 10 \
      --max-area 200000
done
```

### b값 확인 후 조건부 처리
```bash
# 먼저 b값 확인
python -c "
import cv2
import numpy as np
import glob

for img_path in glob.glob('datasets/1첩/*.tif'):
    img = cv2.imread(img_path)
    lab = cv2.cvtColor(img, cv2.COLOR_BGR2LAB)
    b = lab[:,:,2]
    avg_b = np.mean(b)
    print(f'{img_path}: b={avg_b:.1f}')
"

# 조건부 실행 (bash)
for img in datasets/1첩/*.tif; do
    name=$(basename "$img" .tif)
    # b값에 따라 다른 threshold 사용
    # (수동으로 구분 필요)
    python extract_whiteness_based.py \
      --input "$img" \
      --output-dir "results/${name}_b138" \
      --method lab_b \
      --s-threshold 138 \
      --min-area 10 \
      --max-area 200000
done
```

---

## 결과 디렉토리

### 생성된 결과
```
results/
├── test_small_b138/              # 254개
├── test_small_b138_maxarea200k/  # 254개 (동일)
├── w_0001_b138/                  # 335개
├── w_0003_b138/                  # 267개
├── w_0005_b138/                  # 239개
├── w_0005_b138_maxarea200k/      # 239개 (동일)
├── w_0007_b138/                  # 367개
├── w_0010_b138/                  # 348개
├── w_0015_b138/                  # 163개
└── w_0018_b138/                  # 2,626개
```

---

## 최종 권장 사항

### 1. max-area 증가
```bash
--max-area 200000  # 기본값 100000에서 증가
```

**이유**: w_0001(71k), w_0010(73k) 같은 큰 구멍 포함

---

### 2. 이미지별 threshold 조정

#### 대부분 문서 (b≥140)
```bash
--s-threshold 138
```

#### 심각한 손상 (b<140)
```bash
--s-threshold 135  # 또는 더 낮게
```

---

### 3. 품질 확인

각 결과의 `comparison.png`를 육안으로 확인:
- 과검출: threshold를 낮춤 (138 → 135)
- 과소검출: threshold를 높임 (138 → 140)

---

## 다음 단계

1. **나머지 이미지 처리**:
   - w_0002, w_0004, w_0006, w_0008, w_0009 등

2. **다른 첩 처리**:
   - datasets/2첩/, 3첩/, ... 처리

3. **자동 threshold 선택**:
   - b평균값에 따라 자동으로 threshold 조정하는 스크립트 작성

4. **w_0018 같은 심각한 손상 문서**:
   - Edge detection 방법 시도
   - 다른 색공간 시도 (HSV, YCrCb 등)

---

## 요약

### ✅ 성공
- b=138이 대부분 문서에 효과적
- max-area=200000 필요성 확인
- 8개 이미지 테스트 완료

### ⚠️ 주의
- w_0010: b평균 138.2 (threshold에 근접)
- w_0018: b평균 137.8 (심각한 손상)

### 📝 권장
```bash
python extract_whiteness_based.py \
  --method lab_b \
  --s-threshold 138 \
  --min-area 10 \
  --max-area 200000
```
